# Автоматическое укрупнение чанков

С недавних пор в системе появилась возможность автоматического укрупнения чанков для статических таблиц на стороне мастер-сервера. В отличие от операции [Merge](../../../_includes/user-guide/data-processing/operations/merge.md), данный способ не использует вычислительные ресурсы пула.

Для того чтобы включить автоматическое перемерживание, достаточно выставить у таблицы атрибут `@chunk_merger_mode` в одно из значений ниже. По умолчанию мы рекомендуем использовать `auto` (другие режимы тоже разрешены, но переключаться на них стоит, только хорошо понимая, зачем):

```bash
yt set //home/dir_with_tables/table_i_want_to_merge/@chunk_merger_mode auto
```

Если хочется мержить все таблицы в определенном поддереве, атрибут можно выставить на всю директорию:
```bash
yt set //home/dir_with_tables/@chunk_merger_mode auto
```

У автоматического перемерживания есть несколько режимов работы:
1. **shallow** — объединение чанков на уровне метаданных, без распаковки. Такой подход, конечно, работает, только если чанки достаточно "похожи" (в плане сортированности, колонок, compression-кодека и т.д.). А еще в какой-то момент у результирующего чанка может стать слишком много [блоков](../../../user-guide/storage/chunks.md#chunk-size).
2. **deep** — объединение чанков с полным пережатием (путем вычитывания всех входных чанков и записи в новый). Этот режим существенно более дорогой, чем предыдущий, но позволяет объединить чанки с разными характеристиками, которые оказались в одной таблице. Этот режим можно также использовать, чтобы избавиться от мелких блоков или чанков в старых форматах.
3. **auto** — объединение чанков в shallow режиме с откатом в deep в случае неудачи. Как видно из названия, рекомендуется по умолчанию.

Следует заметить, что `chunk_merger_mode` — это [наследуемый атрибут](../../../user-guide/storage/chunks.md#common). Это означает, что после его установки его значение будут наследовать все новые таблицы в директории, но для старых ничего не поменяется, поэтому в момент включения пройтись по всем таблицам все же придется.

Укрупнение чанков инициируется в момент установки атрибута и каждый раз при записи в таблицу (при этом в случае дозаписи в качестве оптимизации мы попытаемся перемержить лишь хвост таблицы).

Также стоит обратить внимание, что автоматическое укрупнение не будет работать для аккаунта tmp (для всех остальных аккаунтов по умолчанию оно будет разрешено).

{% note info "Примечание" %}

Данный механизм работает только для статических таблиц. Динамические таблицы имеют собственные механизмы укрупнения чанков, выставление атрибута `chunk_merger_mode` для них ни к чему не приведет.

{% endnote %}

## Немного про диагностику

У таблиц есть несколько системных атрибутов, позволяющих узнать о текущем статусе укрупнения чанков. Но они не отображаются в веб интерфейсе, чтобы их посмотреть, нужно запросить эти атрибуты через CLI.

`@chunk_merger_status` — статус таблицы в пайплайне мерджа, может принимать значения `not_in_merge_pipeline`, `awaiting_merge` и `in_merge_pipeline`. С момента срабатывания триггера для укрупнения чанков и до момента, когда мерджер перестанет с таблицей что-либо делать, может пройти существенное количество времени. Если вы выставили `chunk_merger_mode` на таблицу, но чанки в ней все еще мелки, то стоит посмотреть на `chunk_merger_status` и дождаться, пока он станет `not_in_merge_pipeline`.

`@chunk_merger_traversal_info/chunk_count` — количество уже обработанных мержером чанков, укрупнять которые мы больше не планируем. Может быть полезно для понимания, какие чанки уже не помержатся.

{% note info "Примечание" %}

Пусть для некоторой таблицы мы включили автоматическое укрупнение, после которого в ней осталась 1000 чанков, а теперь мы собираемся дописывать данные в конец. Понятно, что нет никакого смысла после каждой записи рассматривать чанки с самого начала, т.к. если мы не захотели их объединить до этого, то не захотим и сейчас. При этом мы все еще можем захотеть склеить свежедобавленный чанк с некоторым количеством последних из старых. Так, если `@chunk_merger_traversal_info/chunk_count` равен, скажем, 980, то в дальнейшем будут рассматриваться лишь последние 20 чанков, и именно их мы будем пытаться перемержить с новыми при будущих дозаписях.

{% endnote %}

На этом [графике](https://monitoring.yandex-team.ru/projects/yt/dashboards/monkq434ofbsaj1lfjvt/view/graph/4iotctsws/queries?from=now-30m&to=now&p.cluster=hahn&p.cell_tag=-&p.cell_id=%2A&p.container=-&p.account=-&refresh=60000) видны поаккаунтные очереди на укрупнение чанков. Если очередь вашего аккаунта пуста, то стоит убедиться, что выставлен правильный атрибут для всех нужных таблиц (и если это так, но очередь по-прежнему всегда пуста, а таблицы не мержатся, сделать тикет в YTADMINREQ).

Автоматическое укрупнение чанков не берет локи на таблицы, поэтому перемерживание должно быть полностью незаметно и не мешать остальным процессам. Однако, у этого есть неприятное следствие: иногда такие мержи могут завершаться неудачей (например, если за время выполнения мержа таблица будет полностью перезаписана новыми данными). Система автоматически ретраит неудавшиеся мержи в случае, если это возможно (это может быть невозможно в случае, если таблица была удалена или стала динамической), однако если таблица часто перезаписывается новыми данными, такой процесс может сходиться долго.

На этом [графике](https://monitoring.yandex-team.ru/projects/yt/dashboards/monkq434ofbsaj1lfjvt/view/graph/ykbmokv3d/queries?cluster=hahn&p.cell_tag=-&p.cell_id=%2A&p.container=-&p.account=-&refresh=60000) можно увидеть количество успешных и неудавшихся мержей. Наличие определенного количества неудавшихся мержей — это нормально, и полностью избавиться от них не получится, но если оно превышает количество успешных, то стоит обратить на это внимание. Возможно, мерж включен для таблиц, которые постоянно перезаписываются с нуля новыми данными, или очень недолгоживущих таблиц. В таком случае автоматическое перемерживание для них лучше отключить.
